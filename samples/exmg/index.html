<html>
    <head>
        <!-- App -->

        <script>
            
        </script>
        <script src="../../dist/dash.all.debug.js"></script>

        <!-- EXMG MQTT -->
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    </head>
    <body>

        <p style="text-align: center;">
            <video style="width: 80%" id="videoPlayer" controls muted></video>
            <br><br>
            <button onclick="go()">Go</button>
        </p>

        <p style="text-align: left; width: 60%; margin: auto;">
            <label>EXMG live-cipher sync (audio):</label>
            <output id="key-range-audio-out"></output>
            <br>
            <label>EXMG live-cipher sync (video):</label>
            <output id="key-range-video-out"></output>
            <br>
            <label>Buffered (decrypted/decode&renderable) time-range:</label>
            <output id="buffered-range-out"></output>
        </p>

        <script>

            const searchParams = new URL(window.location).searchParams;

            let streamUrl = searchParams.get('streamUrl');
            if (!streamUrl) {
                streamUrl = `https://exmachina-ull-demo.akamaized.net/cmaf/live/664379/stephan/out.mpd`
            }

            let keyUrl = searchParams.get('keyUrl');
            if (!keyUrl) {
                throw new Error('Need keyUrl query-param');
                alert('Please pass keyUrl query-param');
            }

            const video = document.querySelector("#videoPlayer");
            let player = null;

            function go() {

                player && player.reset();
                player = dashjs.MediaPlayer().create();

                window.player = player;

                player.updateSettings({ 
                    debug: { 
                        //logLevel: dashjs.Debug.LOG_LEVEL_DEBUG 
                    }, 
                    streaming: {
                        liveDelay: 0,
                        //lowLatencyEnabled: true,
                        exmg: {
                            keyFilesBaseUrl: keyUrl,
                            keyUpdateIntervalMs: 1000
                        }
                    },
                });

                player.initialize(video, streamUrl, true);

                player.on('fragmentLoadingStarted', () => {
                    if (window.exmgEvents) return;

                    let keyRangeMaxSecs = [0, 0]

                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherMessage', (event) => {
                        console.log('exmgLiveSyncCipherMessage:', event)

                        let mediaType;
                        if (event.mediaType === 'audio') {
                            mediaType = 0;
                        } else if (event.mediaType === 'video') {
                            mediaType = 1;
                        }

                        let keyRangeSecs = event.mediaTimeSecs + event.keyDurationSecs;
                        keyRangeMaxSecs[mediaType] = Math.max(keyRangeMaxSecs[mediaType], keyRangeSecs);
                        document.querySelector(`#key-range-${event.mediaType}-out`).value = keyRangeMaxSecs[mediaType];

                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherMiss', (event) => {
                        console.log('exmgLiveSyncCipherMiss:', event)
                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherDecrypting', (event) => {
                        console.log('exmgLiveSyncCipherDecrypting:', event)
                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherDecrypted', (event) => {
                        console.log('exmgLiveSyncCipherDecrypted:', event)
                    });
                    window.exmgEvents = true;

                    setInterval(() => {

                        //console.log(video.buffered)

                        const rangesLen = video.buffered.length
                        if (!rangesLen) return;
                        document.querySelector('#buffered-range-out').value 
                            = '[' + video.buffered.start(rangesLen - 1) + ', ' + video.buffered.end(rangesLen - 1) + ']' 
                               // + video.buffered.end(rangesLen - 1) - video.currentTime;

                    }, 1000)
                });

                video.play();
            }
        </script>
    </body>
</html>