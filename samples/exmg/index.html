<html>
    <head>
        <!-- App -->

        <script>
            
        </script>
        <script src="../../dist/dash.all.debug.js"></script>

        <!-- EXMG MQTT -->
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    </head>
    <body>

        <p style="text-align: center;">
            <video style="width: 80%" id="videoPlayer" controls muted></video>
            <br><br>
            <button onclick="go()">Go</button>
        </p>

        <p>
            <label>EXMG live-cipher sync (audio):</label>
            <output id="key-range-audio-out"></output>
            <br>
            <label>EXMG live-cipher sync (video):</label>
            <output id="key-range-video-out"></output>
        </p>

        <script>
            var url = `http://localhost:8080/out.mpd`;
            var video = document.querySelector("#videoPlayer");
            var player = null;

            function go() {
                player && player.reset();
                player = dashjs.MediaPlayer().create();

                window.player = player;

                player.updateSettings({ 
                    debug: { 
                        //logLevel: dashjs.Debug.LOG_LEVEL_DEBUG 
                    }, 
                    streaming: {
                        liveDelay: 0,
                        //lowLatencyEnabled: true,
                        exmg: {
                            keyFilesBaseUrl: "http://localhost:8080",
                            keyUpdateIntervalMs: 2000
                        }
                    },
                });

                player.initialize(video, url, true);

                player.on('fragmentLoadingStarted', () => {
                    if (window.exmgEvents) return;

                    let keyRangeMaxSecs = [0, 0]

                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherMessage', (event) => {
                        console.log('exmgLiveSyncCipherMessage:', event)

                        let mediaType;
                        if (event.mediaType === 'audio') {
                            mediaType = 0;
                        } else if (event.mediaType === 'video') {
                            mediaType = 1;
                        }

                        let keyRangeSecs = event.mediaTimeSecs + event.keyDurationSecs;
                        keyRangeMaxSecs[mediaType] = Math.max(keyRangeMaxSecs[mediaType], keyRangeSecs);
                        document.querySelector(`#key-range-${event.mediaType}-out`).value = keyRangeMaxSecs[mediaType];

                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherMiss', (event) => {
                        console.log('exmgLiveSyncCipherMiss:', event)
                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherDecrypting', (event) => {
                        console.log('exmgLiveSyncCipherDecrypting:', event)
                    });
                    window.exmgFragmentDecrypt.eventBus.on('exmgLiveSyncCipherDecrypted', (event) => {
                        console.log('exmgLiveSyncCipherDecrypted:', event)
                    });
                    window.exmgEvents = true;
                });

                video.play();
            }
        </script>
    </body>
</html>