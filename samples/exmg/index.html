<html>
    <head>
        <!-- Local dash.js build -->
        <script src="../../dist/dash.all.debug.js"></script>

        <!-- MQTT client -->
        <!-- <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script> -->

        <!-- Plotly.js -->
        <script src="./plotly-1.54.6.js"></script>

        <style>
            body {
                text-align: center;
                font-family: Verdana, Geneva, Tahoma, sans-serif;
            }

            output {
                font-size: 2em;
                font-family: monospace;
                background-color: aquamarine;
            }

            button {
                font-size: 2em;
                font-weight: lighter
            }
        </style>

    </head>
    <body>

        <h1>SecureSync Demo</h1>

        <p style="text-align: left; width: 60%; margin: auto;">
            <label>Keys loaded time-range (audio & video):</label>
            <output id="key-range-audio-out"></output> & <output id="key-range-video-out"></output> [s]
            <br><br>
            <label>Playable time-range (decrypted):</label>
            <output id="buffered-range-out"></output> [s]
        </p>

        <p style="text-align: center;">
            <button style="display: none;" onclick="start()">Start</button>
            <br><br>
            <video style="width: 80%" id="videoPlayer" controls muted></video>
        </p>

        <p style="width: 60%;">
            <div id="buffer-graph"></div>
        </p>
    </body>

    <script src="./graphs.js"></script>

    <script>
        'use strict';

        const KEY_UPDATE_INTERVAL_MS = 1000;

        const perf = window.performance;
        const searchParams = new URL(window.location).searchParams;

        let streamUrl = searchParams.get('streamUrl');
        if (!streamUrl) {
            streamUrl = `https://exmachina-ull-demo.akamaized.net/cmaf/live/664379/stephan/out.mpd`
        }

        let keyUrl = searchParams.get('keyUrl');
        if (!keyUrl) {
            throw new Error('Need keyUrl query-param');
            alert('Please pass keyUrl query-param');
        }

        let liveDelay = parseFloat(searchParams.get('liveDelay'));
        if (!Number.isFinite(liveDelay)) {
            liveDelay = 0;
        }

        let player = null;
        let startTime = null;

        const video = document.querySelector("#videoPlayer");

        const dashjsSettings = {
            debug: {
                //logLevel: dashjs.Debug.LOG_LEVEL_DEBUG
            },
            streaming: {
                liveDelay,
                //lowLatencyEnabled: true,
                exmg: {
                    keyFilesBaseUrl: keyUrl,
                    keyUpdateIntervalMs: KEY_UPDATE_INTERVAL_MS
                }
            },
        };

        console.log('dash.js Settings:', dashjsSettings)

        function start() {

            startTime = perf.now();

            player && player.reset();
            player = dashjs.MediaPlayer().create();

            window.player = player;

            player.updateSettings(dashjsSettings);

            player.on('exmgLiveSyncCipherPayload', (event) => {
                console.log('exmgLiveSyncCipherPayload', event);

                const {request} = event;
                const mediaEndTime = request.startTime + request.duration;
                switch (request.mediaType) {
                case 'audio':
                    bufferUntilAudio = mediaEndTime;
                    break;
                case 'video':
                    bufferUntilVideo = mediaEndTime;
                    break;
                }
            })

            player.on('exmgLiveSyncCipherMessage', (event) => {
                console.log('exmgLiveSyncCipherMessage:', event)

                let mediaType;
                if (event.mediaType === 'audio') {
                    mediaType = 0;
                } else if (event.mediaType === 'video') {
                    mediaType = 1;
                }

                let keyRangeSecs = event.mediaTimeSecs + event.keyDurationSecs;

                keyRangeMaxSecs[mediaType] = Math.max(keyRangeMaxSecs[mediaType], keyRangeSecs);

                document.querySelector(`#key-range-${event.mediaType}-out`).value = keyRangeMaxSecs[mediaType].toFixed(3);

            });

            player.on('exmgLiveSyncCipherMiss', (event) => {
                console.log('exmgLiveSyncCipherMiss:', event)
            });

            player.on('exmgLiveSyncCipherDecrypting', (event) => {
                console.log('exmgLiveSyncCipherDecrypting:', event)
            });

            player.on('exmgLiveSyncCipherDecrypted', (event) => {
                console.log('exmgLiveSyncCipherDecrypted:', event)
            });

            player.initialize(video, streamUrl, true);

            video.play();
        }

        function updateDom() {

            const videoTime = video.currentTime;
            const videoBuffered = video.buffered;

            const rangesLen = video.buffered.length
            if (!rangesLen) return;

            let currentRangeIdx = -1;
            for (let i = 0; i < rangesLen; i++) {
                if (videoTime >= videoBuffered.start(i)
                    && videoTime <= videoBuffered.end(i)) {
                    currentRangeIdx = i;
                }
            }

            if (currentRangeIdx < 0) return;

            bufferPlayableLength = videoBuffered.end(currentRangeIdx) - videoTime;

            document.querySelector('#buffered-range-out').value
                = `[ ${videoBuffered.start(currentRangeIdx).toFixed(3)} < ${videoTime.toFixed(3)} < ${videoBuffered.end(currentRangeIdx).toFixed(3)} ]`

            updatePlots();
        }

        setInterval(updateDom, KEY_UPDATE_INTERVAL_MS);

        start();

    </script>
</html>